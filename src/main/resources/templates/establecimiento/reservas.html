<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Reservas - BudgetMap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>

<body class="bg-light">

<!-- HEADER -->
<div th:replace="~{layouts/header :: header}"></div>

<div class="container my-5">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a th:href="@{/establecimiento/dashboard}">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">Reservas</li>
        </ol>
    </nav>

    <!-- Título -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="fw-bold">
                <i class="bi bi-calendar-check text-primary"></i>
                Gestión de Reservas
            </h2>
            <p class="text-muted">Administra las reservas de tus clientes</p>
        </div>
    </div>

    <!-- Mensajes de éxito -->
    <div th:if="${param.confirmada}" class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle-fill me-2"></i>
        <strong>¡Reserva confirmada!</strong> El cliente ha sido notificado.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${param.cancelada}" class="alert alert-warning alert-dismissible fade show">
        <i class="bi bi-x-circle-fill me-2"></i>
        <strong>Reserva cancelada.</strong> El cliente ha sido notificado.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row g-3 mb-4">
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="bi bi-clock-history fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-1" 
                        th:text="${reservas != null ? #lists.size(#lists.select(reservas, r -> r.estado.toString() == 'PENDIENTE')) : 0}">
                        0
                    </h4>
                    <p class="text-muted mb-0">Pendientes</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-1"
                        th:text="${reservas != null ? #lists.size(#lists.select(reservas, r -> r.estado.toString() == 'CONFIRMADA')) : 0}">
                        0
                    </h4>
                    <p class="text-muted mb-0">Confirmadas</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-danger mb-2">
                        <i class="bi bi-x-circle fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-1"
                        th:text="${reservas != null ? #lists.size(#lists.select(reservas, r -> r.estado.toString() == 'CANCELADA')) : 0}">
                        0
                    </h4>
                    <p class="text-muted mb-0">Canceladas</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="bi bi-calendar3 fs-1"></i>
                    </div>
                    <h4 class="fw-bold mb-1" th:text="${reservas != null ? #lists.size(reservas) : 0}">0</h4>
                    <p class="text-muted mb-0">Total</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Filtros -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Filtrar por estado:</label>
                    <select class="form-select" id="filtroEstado">
                        <option value="">Todos</option>
                        <option value="PENDIENTE">Pendientes</option>
                        <option value="CONFIRMADA">Confirmadas</option>
                        <option value="CANCELADA">Canceladas</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Buscar cliente:</label>
                    <input type="text" class="form-control" id="buscarCliente" placeholder="Nombre o email...">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Limpiar filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Reservas -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">

            <div th:if="${reservas == null || reservas.isEmpty()}" class="text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                <h5 class="text-muted mt-3">No tienes reservas aún</h5>
                <p class="text-muted">Las reservas de tus clientes aparecerán aquí</p>
            </div>

            <div th:unless="${reservas == null || reservas.isEmpty()}" class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <i class="bi bi-hash"></i> ID
                            </th>
                            <th>
                                <i class="bi bi-person"></i> Cliente
                            </th>
                            <th>
                                <i class="bi bi-calendar"></i> Fecha y Hora
                            </th>
                            <th>
                                <i class="bi bi-info-circle"></i> Estado
                            </th>
                            <th class="text-end">
                                <i class="bi bi-gear"></i> Acciones
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tablaReservas">
                        <tr th:each="reserva : ${reservas}" 
                            th:data-estado="${reserva.estado}">
                            
                            <td>
                                <strong th:text="${reserva.id}">#001</strong>
                            </td>

                            <td>
                                <div>
                                    <div class="fw-bold" th:text="${reserva.usuario.nombre}">
                                        Cliente
                                    </div>
                                    <small class="text-muted" th:text="${reserva.usuario.email}">
                                        email@ejemplo.com
                                    </small>
                                </div>
                            </td>

                            <td>
                                <div>
                                    <i class="bi bi-calendar3 text-primary me-1"></i>
                                    <span th:text="${#temporals.format(reserva.fechaReserva, 'dd/MM/yyyy')}">
                                        01/01/2025
                                    </span>
                                </div>
                                <div>
                                    <i class="bi bi-clock text-muted me-1"></i>
                                    <small class="text-muted" 
                                           th:text="${#temporals.format(reserva.fechaReserva, 'HH:mm')}">
                                        10:00
                                    </small>
                                </div>
                            </td>

                            <td>
                                <span class="badge"
                                      th:classappend="${reserva.estado.toString() == 'CONFIRMADA' ? 'bg-success' : 
                                                       reserva.estado.toString() == 'PENDIENTE' ? 'bg-warning text-dark' : 
                                                       'bg-danger'}"
                                      th:text="${reserva.estado}">
                                    PENDIENTE
                                </span>
                            </td>

                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    
                                    <!-- Botón Confirmar (solo si está PENDIENTE) -->
                                    <form th:if="${reserva.estado.toString() == 'PENDIENTE'}"
                                          th:action="@{'/establecimiento/reservas/' + ${reserva.id} + '/confirmar'}"
                                          method="post"
                                          style="display: inline;"
                                          onsubmit="return confirm('¿Confirmar esta reserva?')">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-check-circle"></i> Confirmar
                                        </button>
                                    </form>

                                    <!-- Botón Cancelar (solo si NO está cancelada) -->
                                    <form th:if="${reserva.estado.toString() != 'CANCELADA'}"
                                          th:action="@{'/establecimiento/reservas/' + ${reserva.id} + '/cancelar'}"
                                          method="post"
                                          style="display: inline;"
                                          onsubmit="return confirm('¿Cancelar esta reserva?')">
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="bi bi-x-circle"></i> Cancelar
                                        </button>
                                    </form>

                                    <!-- Botón Ver detalles -->
                                    <button type="button" 
                                            class="btn btn-info btn-sm"
                                            data-bs-toggle="modal"
                                            th:data-bs-target="'#modalReserva' + ${reserva.id}">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- Modales de detalle (uno por cada reserva) -->
    <div th:each="reserva : ${reservas}" 
         class="modal fade" 
         th:id="'modalReserva' + ${reserva.id}" 
         tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle text-primary me-2"></i>
                        Detalle de Reserva #<span th:text="${reserva.id}"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Cliente:</dt>
                        <dd class="col-sm-8" th:text="${reserva.usuario.nombre}">-</dd>

                        <dt class="col-sm-4">Email:</dt>
                        <dd class="col-sm-8" th:text="${reserva.usuario.email}">-</dd>

                        <dt class="col-sm-4">Teléfono:</dt>
                        <dd class="col-sm-8" th:text="${reserva.usuario.telefono ?: 'No registrado'}">-</dd>

                        <dt class="col-sm-4">Fecha:</dt>
                        <dd class="col-sm-8" 
                            th:text="${#temporals.format(reserva.fechaReserva, 'dd/MM/yyyy HH:mm')}">
                            -
                        </dd>

                        <dt class="col-sm-4">Estado:</dt>
                        <dd class="col-sm-8">
                            <span class="badge"
                                  th:classappend="${reserva.estado.toString() == 'CONFIRMADA' ? 'bg-success' : 
                                                   reserva.estado.toString() == 'PENDIENTE' ? 'bg-warning text-dark' : 
                                                   'bg-danger'}"
                                  th:text="${reserva.estado}">
                            </span>
                        </dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- FOOTER -->
<div th:replace="~{layouts/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Filtro por estado
    document.getElementById('filtroEstado').addEventListener('change', function() {
        filtrarTabla();
    });

    // Búsqueda por cliente
    document.getElementById('buscarCliente').addEventListener('input', function() {
        filtrarTabla();
    });

    function filtrarTabla() {
        const estado = document.getElementById('filtroEstado').value;
        const busqueda = document.getElementById('buscarCliente').value.toLowerCase();
        const filas = document.querySelectorAll('#tablaReservas tr');

        filas.forEach(fila => {
            const estadoFila = fila.dataset.estado;
            const textoFila = fila.textContent.toLowerCase();

            const cumpleEstado = !estado || estadoFila === estado;
            const cumpleBusqueda = !busqueda || textoFila.includes(busqueda);

            if (cumpleEstado && cumpleBusqueda) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    }

    function limpiarFiltros() {
        document.getElementById('filtroEstado').value = '';
        document.getElementById('buscarCliente').value = '';
        filtrarTabla();
    }

    // Auto-cerrar alertas
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert-dismissible');
        alerts.forEach(alert => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
</script>

</body>
</html>